package main;

import java.io.BufferedReader;
import java.io.RandomAccessFile;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.channels.Channels;
import java.nio.channels.ReadableByteChannel;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.regex.Pattern;

import data.Company;

public class Downloader {
	private List<Company> stocks;

	public Downloader(List<Company> stocks) {
		this.stocks = stocks;
	}

	public ArrayList<File> download() throws IOException, InterruptedException {
		File dir = new File("data");
		dir.mkdir();
		ArrayList<File> files = new ArrayList<>();
		System.out.println("starting downloading...");
		long start = System.currentTimeMillis();
		for (Company c : stocks) {

			File subDir1 = new File("data" + File.separator + "stock");
			subDir1.mkdir();
			File subDir2 = new File("data" + File.separator + "stock"
					+ File.separator + c.getAbbrev());
			subDir2.mkdir();

			File file = new File("data" + File.separator + "stock"
					+ File.separator + c.getAbbrev() + File.separator
					+ c.getAbbrev() + ".csv");
			if (!file.isFile()) {
				System.out.println(file.toString());
				ReadableByteChannel rbc = Channels.newChannel(c.getUrl()
						.openStream());
				FileOutputStream fos = new FileOutputStream(file);
				fos.getChannel().transferFrom(rbc, 0, Long.MAX_VALUE);
				fos.close();
				rbc.close();
			} else
				update(file, c);

			files.add(file);
		}
		long end = System.currentTimeMillis();
		System.out.println("done downloading (time " + (end - start) + ")");
		return files;
	}

	private static void update(File file, Company c) throws IOException {
		// TODO Auto-generated method stub
		Calendar today = Calendar.getInstance();
		String day = Integer.toString(today.get(Calendar.DAY_OF_MONTH) - 1);
		String month = Integer.toString((today.get(Calendar.MONTH) + 1) % 12);
		String year = Integer.toString(today.get(Calendar.YEAR));

		final Pattern pattern = Pattern.compile(",");

		BufferedReader br = new BufferedReader(new InputStreamReader(
				new FileInputStream(file)));
		br.readLine();
		String line = br.readLine();
		br.close();

		String[] nums = pattern.split(line);
		final Pattern datePattern = Pattern.compile("-");
		String[] date = datePattern.split(nums[0]);
		System.out.println(file + " " + date.toString());
		if (!date[0].equals(year) || !date[1].equals(month)
				|| !date[2].equals(day)) {
			downloadRest(date, file, c);
		}
	}

	private static void downloadRest(String[] date, File file, Company c) {
		// TODO Auto-generated method stub
		// date[0] == year, date[1] == month, date[2] == day

		Calendar today = Calendar.getInstance();
		String day = Integer.toString(today.get(Calendar.DAY_OF_MONTH) - 1);
		String month = Integer.toString((today.get(Calendar.MONTH) + 1) % 12);
		String year = Integer.toString(today.get(Calendar.YEAR));

		Calendar mostRecentDay = Calendar.getInstance();
		mostRecentDay.set(Integer.parseInt(date[0]), Integer.parseInt(date[1]),
				Integer.parseInt(date[2]));
		System.out.println("mostRecentDay: " + mostRecentDay.toString());

		if ((System.currentTimeMillis() - (5 * 86400000)) > mostRecentDay
				.getTimeInMillis()) {

			String urlStr = "http://ichart.finance.yahoo.com/table.csv?s="
					+ c.getAbbrev() + "&d=" + month + "&e=" + day + "&f="
					+ year + "&g=d&a=" + date[1] + "&b=" + date[2] + "&c="
					+ date[0] + "&ignore=.csv";
			try {
				URL url = new URL(urlStr);
				BufferedReader in = new BufferedReader(new InputStreamReader(
						url.openStream()));
				RandomAccessFile raf = new RandomAccessFile(file, "rws");
				raf.readLine();

				String line;
				while ((line = in.readLine()) != null) {
					raf.write(line.getBytes());
				}

				raf.close();
				in.close();

			} catch (MalformedURLException e) {
				System.out.println("URL did not have the correct format..");
				e.printStackTrace();
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}
}
